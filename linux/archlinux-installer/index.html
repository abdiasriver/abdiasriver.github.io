<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Automating Arch Linux Part 3: Creating a Custom Arch Linux Installer | AbdiasRiver</title>
    <meta name="description" content="How to create a script to automate the installation of Arch Linux">
    <link rel="icon" href="/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.e3a321cd.css" as="style"><link rel="preload" href="/assets/js/app.e09b330c.js" as="script"><link rel="preload" href="/assets/js/16.7972a134.js" as="script"><link rel="prefetch" href="/assets/js/10.a8f9e5e8.js"><link rel="prefetch" href="/assets/js/11.6dadc888.js"><link rel="prefetch" href="/assets/js/12.e9e42bba.js"><link rel="prefetch" href="/assets/js/13.5eef80ac.js"><link rel="prefetch" href="/assets/js/14.d904ae96.js"><link rel="prefetch" href="/assets/js/15.a7818c58.js"><link rel="prefetch" href="/assets/js/17.afc2aff7.js"><link rel="prefetch" href="/assets/js/18.0fb88f93.js"><link rel="prefetch" href="/assets/js/19.3d083389.js"><link rel="prefetch" href="/assets/js/2.fe5d27c1.js"><link rel="prefetch" href="/assets/js/3.9cc3fdf5.js"><link rel="prefetch" href="/assets/js/4.ca17b628.js"><link rel="prefetch" href="/assets/js/5.fc2644be.js"><link rel="prefetch" href="/assets/js/6.beb4cc32.js"><link rel="prefetch" href="/assets/js/7.d8cda677.js"><link rel="prefetch" href="/assets/js/8.d29e16a7.js"><link rel="prefetch" href="/assets/js/9.8041cf29.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e3a321cd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">AbdiasRiver</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/" class="nav-link">Blog</a></div><div class="nav-item"><a href="/linux/" class="nav-link router-link-active">Linux</a></div><div class="nav-item"><a href="/windows/" class="nav-link">Windows</a></div><div class="nav-item"><a href="https://github.com/abdiasriver" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/" class="nav-link">Blog</a></div><div class="nav-item"><a href="/linux/" class="nav-link router-link-active">Linux</a></div><div class="nav-item"><a href="/windows/" class="nav-link">Windows</a></div><div class="nav-item"><a href="https://github.com/abdiasriver" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/linux/archlinux-repo-in-aws-bucket/" class="sidebar-link">Hosting an Arch Linux Repo in an Amazon S3 Bucket</a></li><li><a href="/linux/archlinux-meta-packages/" class="sidebar-link">Managing Arch Linux with Meta Packages</a></li><li><a href="/linux/archlinux-installer/" class="active sidebar-link">Creating a Custom Arch Linux Installer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/linux/archlinux-installer/#setting-variables-and-collecting-user-input" class="sidebar-link">Setting Variables and Collecting User Input</a></li><li class="sidebar-sub-header"><a href="/linux/archlinux-installer/#partioning-and-formatting-the-disk" class="sidebar-link">Partioning and Formatting the Disk</a></li><li class="sidebar-sub-header"><a href="/linux/archlinux-installer/#install-the-system-and-bootloader" class="sidebar-link">Install the System and Bootloader</a></li><li class="sidebar-sub-header"><a href="/linux/archlinux-installer/#configuring-the-system" class="sidebar-link">Configuring the System</a></li><li class="sidebar-sub-header"><a href="/linux/archlinux-installer/#other-useful-bits" class="sidebar-link">Other Useful Bits</a></li><li class="sidebar-sub-header"><a href="/linux/archlinux-installer/#the-complete-installer-script" class="sidebar-link">The Complete Installer Script</a></li><li class="sidebar-sub-header"><a href="/linux/archlinux-installer/#hosting-and-running-the-installer" class="sidebar-link">Hosting and Running the Installer</a></li><li class="sidebar-sub-header"><a href="/linux/archlinux-installer/#conclusion" class="sidebar-link">Conclusion</a></li></ul></li></ul> </div> <div class="page"> <div class="content"><h1 id="automating-arch-linux-part-3-creating-a-custom-arch-linux-installer"><a href="#automating-arch-linux-part-3-creating-a-custom-arch-linux-installer" aria-hidden="true" class="header-anchor">#</a> Automating Arch Linux Part 3: Creating a Custom Arch Linux Installer</h1> <p>In this three-part series, I will show you one way to simplify and manage
multiple Arch Linux systems using a custom repo, a set of meta-packages and a
scripted installer. Each part is standalone and can be used by its self, but
they are designed to build upon and complement each other each focusing on a
different part of the problem.</p> <ul><li><strong>Part 1:</strong> <a href="/linux/archlinux-repo-in-aws-bucket/">Hosting an Arch Linux Repo in an Amazon S3 Bucket</a></li> <li><strong>Part 2:</strong> <a href="/linux/archlinux-meta-packages/">Managing Arch Linux with Meta Packages</a></li> <li><strong>Part 3:</strong> <em>Creating a Custom Arch Linux Installer</em></li></ul> <p>The Arch Linux install process can be quite daunting to new users, but once you
understand it, it becomes quite elegant in its simplicity. The best part is
that it's command line based with very little abstraction built on top of it.
This makes it very easy to automate through bash scripting and over the years I
have done just that. In this post, I will go through this script and show you
how to custom it to your own tastes.</p> <p>Note that this is not a general purpose Arch Linux installer, but more a guide
to creating your own installer specific to your needs. I do not recommend
directly using my installer - it is likely to change without notice. Instead,
fork it and make it your own.</p> <p>This guide is also not a tutorial on installing ArchLinux, it assumes some
basic knowledge of the install process and shows you how to script it.
Beginners should first go through the <a href="https://wiki.archlinux.org/index.php/Installation_guide" target="_blank" rel="noopener noreferrer">official install guide<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and be able to
create a working Arch Linux system before following this guide.</p> <h2 id="setting-variables-and-collecting-user-input"><a href="#setting-variables-and-collecting-user-input" aria-hidden="true" class="header-anchor">#</a> Setting Variables and Collecting User Input</h2> <p>There are a few variables that generally change on every install, the hostname
and disk at the very least. There are also settings that you might not want to
bake into a script such as your username and password. So we require a way to
customise the script on each install. The simplest way is to add some variables
to the top of the script for everything you want, blanking out any secrets you
don't want to share.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>hostname<span class="token operator">=</span><span class="token string">&quot;myhost&quot;</span>
</code></pre></div><p>But then the user is forced to download and edit the script before they can run
it.</p> <p>You can get these values from the command line arguments.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>hostname<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${1}</span>&quot;</span>
</code></pre></div><p>Or better yet, throw an error and halt the install process on missing input.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>hostname<span class="token operator">=</span><span class="token string">&quot;${1:?&quot;</span>Missing <span class="token function">hostname</span><span class="token string">&quot;}&quot;</span>
</code></pre></div><p><em>There are many other useful things you can do with <a href="http://wiki.bash-hackers.org/syntax/pe" target="_blank" rel="noopener noreferrer">bash's parameter
substitution<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, which are worth looking up if you want to write bash scripts to
automate things.</em></p> <p>But I always forget the order of these arguments, so I prefer to be prompted
for input. You can do this with the <code>read</code> builtin.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">echo</span> -n <span class="token string">&quot;Hostname: &quot;</span>
<span class="token function">read</span> <span class="token function">hostname</span>
<span class="token keyword">:</span> <span class="token string">&quot;${hostname:?&quot;</span>Missing <span class="token function">hostname</span><span class="token string">&quot;}&quot;</span>
</code></pre></div><p>Note that <code>:</code> is a no-op, we are using it to test the validity of the
<code>hostname</code> variable and to exit early if it is blank (ie the user hit enter
without typing anything).</p> <p>For passwords, you should turn off echoing with <code>-s</code>, echo a blank line (as the
new line char is also not printed) and confirm the password with a second
prompt to avoid typos locking the user out accidentally.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">echo</span> -n <span class="token string">&quot;Password: &quot;</span>
<span class="token function">read</span> -s password
<span class="token keyword">echo</span>
<span class="token keyword">echo</span> -n <span class="token string">&quot;Repeat Password: &quot;</span>
<span class="token function">read</span> -s password2
<span class="token keyword">echo</span>
<span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$password</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;<span class="token variable">$password2</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span> <span class="token keyword">echo</span> <span class="token string">&quot;Passwords did not match&quot;</span><span class="token punctuation">;</span> <span class="token keyword">exit</span> 1<span class="token punctuation">;</span> <span class="token punctuation">)</span>
</code></pre></div><p>But the Arch live disk comes with the dialog utility, this opens up another
option for collecting user input.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>hostname<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>dialog --stdout --inputbox <span class="token string">&quot;Enter hostname&quot;</span> 0 0<span class="token variable">)</span></span> <span class="token operator">||</span> <span class="token keyword">exit</span> 1
<span class="token keyword">:</span> $<span class="token punctuation">{</span>hostname:?<span class="token string">&quot;hostname cannot be empty&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p>Or use <code>--passwordbox</code> instead of <code>--inputbox</code> for passwords. Dialog also lets
us do more complicated things like displaying a list of disks for the user to
pick from.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>devicelist<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>lsblk -dplnx size -o name,size <span class="token operator">|</span> <span class="token function">grep</span> -Ev <span class="token string">&quot;boot|rpmb|loop&quot;</span> <span class="token operator">|</span> tac<span class="token variable">)</span></span>
device<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>dialog --stdout --menu <span class="token string">&quot;Select installation disk&quot;</span> 0 0 0 $<span class="token punctuation">{</span>devicelist<span class="token punctuation">}</span><span class="token variable">)</span></span> <span class="token operator">||</span> <span class="token keyword">exit</span> 1
</code></pre></div><p><img src="/linux/archlinux-installer/01-dialog-disk.png" alt="dialog disk selection"></p> <p>In addition to looking fancy, this also helps to reduce typos and requires less
typing. The list is sorted by reverse size so the disk you want is likely at
the top of the list.</p> <h2 id="partioning-and-formatting-the-disk"><a href="#partioning-and-formatting-the-disk" aria-hidden="true" class="header-anchor">#</a> Partioning and Formatting the Disk</h2> <p>Most people are familiar with <code>fdisk</code> or <code>gdisk</code> for partitions their disk. But
you might want to consider their lesser used sisters, <code>cfdisk</code> and <code>cgdisk</code> if
you prefer a more interactive approach. Whichever you prefer you can launch it
with a disk to let the user format it however they want.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>gdisk <span class="token string">&quot;<span class="token variable">${device}</span>&quot;</span>
</code></pre></div><p>This works fine inside a script, you are able to interact with it like you are
user as well, and when you exit it our script will continue.</p> <p>The major problem with this interactive approach is figuring out the formatting
and layout the user wants or expected for that install. You are mostly forced to
ask the user what they want to do with each partition they created, which
complicates the script and install process quite a bit. Or just assume a layout
and hope the user formatted it correctly.</p> <p>Alternatively, if most or all of your systems are formatted identically, you can
hardcode the layout into the script. This keeps the script simpler with fewer
steps to go through. In the event that you do need a custom disk layout for some
special case, you can download and manually edit the script or even delete the
formatting section entirely and formatting it manually beforehand.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>parted --script <span class="token string">&quot;<span class="token variable">${device}</span>&quot;</span> -- mklabel gpt \
  mkpart ESP fat32 1Mib 129MiB \
  <span class="token keyword">set</span> 1 boot on \
  mkpart primary linux-swap 129MiB 2177MiB \
  mkpart primary ext4 2177MiB 100%
</code></pre></div><p>You can make this more flexible by allowing the user to specify the size of the
ESP or swap space, or even calculate the swap based on the available ram.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>swap_size<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">free</span> --mebi <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/Mem:/ {print <span class="token variable">$2</span>}'</span><span class="token variable">)</span></span>
swap_end<span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span> $swap_size <span class="token operator">+</span> <span class="token number">129</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token variable">))</span></span>MiB

parted --script <span class="token string">&quot;<span class="token variable">${device}</span>&quot;</span> -- mklabel gpt \
  mkpart ESP fat32 1Mib 129MiB \
  <span class="token keyword">set</span> 1 boot on \
  mkpart primary linux-swap 129MiB <span class="token variable">${swap_end}</span> \
  mkpart primary ext4 <span class="token variable">${swap_end}</span> 100%
</code></pre></div><p>Note that I work in MiB to allow parted some freedom to align the partitions
correctly and as such add an extra meg to the size to account for rounding
errors.</p> <p>Before we can format the partitions, we need a reference to their device file.
For most systems this is trivial, just add the partition number to the device
file.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>part_boot<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${device}</span>1&quot;</span>
</code></pre></div><p>But I found a couple of systems that this does not work. Instead, you may need
to add <code>p1</code> to the device file instead. You should be familiar with this if
your system is one of them, but generally, this is laptops with <code>/dev/mmcblk0</code>
or <code>/dev/nvme0n1</code> disks.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>part_boot<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${device}</span>p1&quot;</span>
</code></pre></div><p>To generalise over these two types of disks you can use <code>ls</code> and <code>grep</code> to find
and filter the actual partition. I found the bashes globbing was not powerful
enough to filter out just a single partition while ignoring device files such
as <code>/dev/mmcblk0boot1</code> that also exist on some systems.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>part_boot<span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> $<span class="token punctuation">{</span>device<span class="token punctuation">}</span>* <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">&quot;^<span class="token variable">${device}</span>p?1$&quot;</span><span class="token variable">)</span></span>&quot;</span>
</code></pre></div><p>Once you have identified the partitions, format and mount them to your desired
locations.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>mkfs.vfat -F32 <span class="token string">&quot;<span class="token variable">${part_boot}</span>&quot;</span>
mkswap <span class="token string">&quot;<span class="token variable">${part_swap}</span>&quot;</span>
mkfs.f2fs -f <span class="token string">&quot;<span class="token variable">${part_root}</span>&quot;</span>

swapon <span class="token string">&quot;<span class="token variable">${part_swap}</span>&quot;</span>
<span class="token function">mount</span> <span class="token string">&quot;<span class="token variable">${part_root}</span>&quot;</span> /mnt
<span class="token function">mkdir</span> /mnt/boot
<span class="token function">mount</span> <span class="token string">&quot;<span class="token variable">${part_boot}</span>&quot;</span> /mnt/boot
</code></pre></div><p>Note that if you want swap you should enable the swap partition so that
<code>genfstab</code> picks it up correctly.</p> <h2 id="install-the-system-and-bootloader"><a href="#install-the-system-and-bootloader" aria-hidden="true" class="header-anchor">#</a> Install the System and Bootloader</h2> <p>We are ready to pacstrap the system with any and all packages you want on your
final system. I use the meta-packages I created in <a href="/linux/archlinux-meta-packages/">part 2</a>, which will, in
turn, install all the packages I want on my base system. For this, I need to
append my repo to the end of <code>/etc/pacman.conf</code> before running <code>pacstrap</code>.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;&gt;</span>/etc/pacman.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[mdaffin]
SigLevel = Optional TrustAll
Server = <span class="token variable">$REPO_URL</span>
EOF</span>

pacstrap /mnt mdaffin-desktop
</code></pre></div><p>Now to make our system actually bootable we must install a bootloader. I use
UEFI on my systems and as such use <code>bootctl</code>. For commands that you want to run
inside the context of your installed system wrap them with <code>arch-chroot /mnt</code>.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>arch-chroot /mnt bootctl <span class="token function">install</span>

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">&gt;</span> /mnt/boot/loader/loader.conf
default arch
EOF

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">&gt;</span> /mnt/boot/loader/entries/arch.conf
title    Arch Linux
linux    /vmlinuz-linux
initrd   /initramfs-linux.img
options  root<span class="token operator">=</span>PARTUUID<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>blkid -s PARTUUID -o value <span class="token string">&quot;<span class="token variable">$part_root</span>&quot;</span><span class="token variable">)</span></span> rw
EOF
</code></pre></div><h2 id="configuring-the-system"><a href="#configuring-the-system" aria-hidden="true" class="header-anchor">#</a> Configuring the System</h2> <p>The last thing we need to do is configure the system. This stage is quite short
for my systems as most of the work is done by the meta-packages that I created
in <a href="/linux/archlinux-meta-packages/">part 2</a>. If you choose not to use meta-packages then expand this as much as
you require. You can automate the configuration of your entire set up if you
want to or bootstrap configuration managers like <a href="https://saltstack.com/" target="_blank" rel="noopener noreferrer">SaltStack<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> or <a href="https://www.ansible.com/" target="_blank" rel="noopener noreferrer">Ansible<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> if
you want to get really fancy.</p> <p>At a minimum run <code>genfstab</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>genfstab -t PARTUUID /mnt <span class="token operator">&gt;&gt;</span> /mnt/etc/fstab
</code></pre></div><p>Set your hostname</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">echo</span> <span class="token string">&quot;<span class="token variable">${hostname}</span>&quot;</span> <span class="token operator">&gt;</span> /mnt/etc/hostname
</code></pre></div><p>Create a user and set roots password</p> <div class="language-bash extra-class"><pre class="language-bash"><code>arch-chroot /mnt <span class="token function">useradd</span> -mU -s /usr/bin/zsh -G wheel,uucp,video,audio,storage,games,input <span class="token string">&quot;<span class="token variable">$user</span>&quot;</span>
arch-chroot /mnt chsh -s /usr/bin/zsh

<span class="token keyword">echo</span> <span class="token string">&quot;<span class="token variable">$user</span>:<span class="token variable">$password</span>&quot;</span> <span class="token operator">|</span> chpasswd --root /mnt
<span class="token keyword">echo</span> <span class="token string">&quot;root:<span class="token variable">$password</span>&quot;</span> <span class="token operator">|</span> chpasswd --root /mnt
</code></pre></div><h2 id="other-useful-bits"><a href="#other-useful-bits" aria-hidden="true" class="header-anchor">#</a> Other Useful Bits</h2> <p>There are a couple of other bits in the script that have nothing to do with
installing Arch Linux but improve the error handling and make it easier to
debug problems.</p> <p>First, there is my standard preamble, hardening the [script against
failure][bash strict mode], which if you have been following my posts you
should start to recognise.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">set</span> -uo pipefail
<span class="token function">trap</span> <span class="token string">'s=<span class="token variable">$?</span>; echo &quot;<span class="token variable">$0</span>: Error on line &quot;<span class="token variable">$LINENO</span>&quot;: <span class="token variable">$BASH_COMMAND</span>&quot;; exit <span class="token variable">$s</span>'</span> ERR
</code></pre></div><p>And since the terminal on a live USB does not offer the ability scrolling by
default it is easy to lose the output and errors from programs as they scroll
off the screen. Most of the time this is not an issue, but when something goes
wrong you wish you had it. To get around this I redirect stdout and stderr of
the script to the <code>tee</code> command. This splits the stream, continuing to output
it to the screen but also writes it to a log file in case there is a need to
inspect it later. Honestly, I have only ever used this output once, but it is
not expensive or complicated to do so I just leave it in.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">exec</span> 1<span class="token operator">&gt;</span> <span class="token operator">&gt;</span><span class="token punctuation">(</span>tee <span class="token string">&quot;stdout.log&quot;</span><span class="token punctuation">)</span>
<span class="token function">exec</span> 2<span class="token operator">&gt;</span> <span class="token operator">&gt;</span><span class="token punctuation">(</span>tee <span class="token string">&quot;stderr.log&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>I also ensure ntp is enabled as I have systems that like to drift when
unpowered for a long time.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>timedatectl set-ntp <span class="token boolean">true</span>
</code></pre></div><h2 id="the-complete-installer-script"><a href="#the-complete-installer-script" aria-hidden="true" class="header-anchor">#</a> The Complete Installer Script</h2> <p>Here is my version, at the time of writing, of the installer script in its
entirety. You can find my <a href="https://github.com/mdaffin/arch-pkgs/blob/master/installer/install-arch" target="_blank" rel="noopener noreferrer">live/latest incarnation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> in my <a href="https://github.com/mdaffin/arch-pkgs" target="_blank" rel="noopener noreferrer">arch-pkgs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> git
repository alongside all of the other resources I discuss in this series. I
highly recommend that you start with this as a base, fork it or place it in
your own repo and customise it to your liking. My version is likely to change
in the future as I evolve how I run my systems.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># WARNING: this script will destroy data on the selected disk.</span>
<span class="token comment"># This script can be run by executing the following:</span>
<span class="token comment">#   curl -sL https://git.io/vNxbN | bash</span>
<span class="token keyword">set</span> -uo pipefail
<span class="token function">trap</span> <span class="token string">'s=<span class="token variable">$?</span>; echo &quot;<span class="token variable">$0</span>: Error on line &quot;<span class="token variable">$LINENO</span>&quot;: <span class="token variable">$BASH_COMMAND</span>&quot;; exit <span class="token variable">$s</span>'</span> ERR

REPO_URL<span class="token operator">=</span><span class="token string">&quot;https://s3.eu-west-2.amazonaws.com/mdaffin-arch/repo/x86_64&quot;</span>

<span class="token comment">### Get infomation from user ###</span>
hostname<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>dialog --stdout --inputbox <span class="token string">&quot;Enter hostname&quot;</span> 0 0<span class="token variable">)</span></span> <span class="token operator">||</span> <span class="token keyword">exit</span> 1
<span class="token function">clear</span>
<span class="token keyword">:</span> $<span class="token punctuation">{</span>hostname:?<span class="token string">&quot;hostname cannot be empty&quot;</span><span class="token punctuation">}</span>

user<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>dialog --stdout --inputbox <span class="token string">&quot;Enter admin username&quot;</span> 0 0<span class="token variable">)</span></span> <span class="token operator">||</span> <span class="token keyword">exit</span> 1
<span class="token function">clear</span>
<span class="token keyword">:</span> $<span class="token punctuation">{</span>user:?<span class="token string">&quot;user cannot be empty&quot;</span><span class="token punctuation">}</span>

password<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>dialog --stdout --passwordbox <span class="token string">&quot;Enter admin password&quot;</span> 0 0<span class="token variable">)</span></span> <span class="token operator">||</span> <span class="token keyword">exit</span> 1
<span class="token function">clear</span>
<span class="token keyword">:</span> $<span class="token punctuation">{</span>password:?<span class="token string">&quot;password cannot be empty&quot;</span><span class="token punctuation">}</span>
password2<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>dialog --stdout --passwordbox <span class="token string">&quot;Enter admin password again&quot;</span> 0 0<span class="token variable">)</span></span> <span class="token operator">||</span> <span class="token keyword">exit</span> 1
<span class="token function">clear</span>
<span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$password</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;<span class="token variable">$password2</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span> <span class="token keyword">echo</span> <span class="token string">&quot;Passwords did not match&quot;</span><span class="token punctuation">;</span> <span class="token keyword">exit</span> 1<span class="token punctuation">;</span> <span class="token punctuation">)</span>

devicelist<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>lsblk -dplnx size -o name,size <span class="token operator">|</span> <span class="token function">grep</span> -Ev <span class="token string">&quot;boot|rpmb|loop&quot;</span> <span class="token operator">|</span> tac<span class="token variable">)</span></span>
device<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>dialog --stdout --menu <span class="token string">&quot;Select installation disk&quot;</span> 0 0 0 $<span class="token punctuation">{</span>devicelist<span class="token punctuation">}</span><span class="token variable">)</span></span> <span class="token operator">||</span> <span class="token keyword">exit</span> 1
<span class="token function">clear</span>

<span class="token comment">### Set up logging ###</span>
<span class="token function">exec</span> 1<span class="token operator">&gt;</span> <span class="token operator">&gt;</span><span class="token punctuation">(</span>tee <span class="token string">&quot;stdout.log&quot;</span><span class="token punctuation">)</span>
<span class="token function">exec</span> 2<span class="token operator">&gt;</span> <span class="token operator">&gt;</span><span class="token punctuation">(</span>tee <span class="token string">&quot;stderr.log&quot;</span><span class="token punctuation">)</span>

timedatectl set-ntp <span class="token boolean">true</span>

<span class="token comment">### Setup the disk and partitions ###</span>
swap_size<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">free</span> --mebi <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/Mem:/ {print <span class="token variable">$2</span>}'</span><span class="token variable">)</span></span>
swap_end<span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span> $swap_size <span class="token operator">+</span> <span class="token number">129</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token variable">))</span></span>MiB

parted --script <span class="token string">&quot;<span class="token variable">${device}</span>&quot;</span> -- mklabel gpt \
  mkpart ESP fat32 1Mib 129MiB \
  <span class="token keyword">set</span> 1 boot on \
  mkpart primary linux-swap 129MiB <span class="token variable">${swap_end}</span> \
  mkpart primary ext4 <span class="token variable">${swap_end}</span> 100%

<span class="token comment"># Simple globbing was not enough as on one device I needed to match /dev/mmcblk0p1</span>
<span class="token comment"># but not /dev/mmcblk0boot1 while being able to match /dev/sda1 on other devices.</span>
part_boot<span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> $<span class="token punctuation">{</span>device<span class="token punctuation">}</span>* <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">&quot;^<span class="token variable">${device}</span>p?1$&quot;</span><span class="token variable">)</span></span>&quot;</span>
part_swap<span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> $<span class="token punctuation">{</span>device<span class="token punctuation">}</span>* <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">&quot;^<span class="token variable">${device}</span>p?2$&quot;</span><span class="token variable">)</span></span>&quot;</span>
part_root<span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> $<span class="token punctuation">{</span>device<span class="token punctuation">}</span>* <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">&quot;^<span class="token variable">${device}</span>p?3$&quot;</span><span class="token variable">)</span></span>&quot;</span>

wipefs <span class="token string">&quot;<span class="token variable">${part_boot}</span>&quot;</span>
wipefs <span class="token string">&quot;<span class="token variable">${part_swap}</span>&quot;</span>
wipefs <span class="token string">&quot;<span class="token variable">${part_root}</span>&quot;</span>

mkfs.vfat -F32 <span class="token string">&quot;<span class="token variable">${part_boot}</span>&quot;</span>
mkswap <span class="token string">&quot;<span class="token variable">${part_swap}</span>&quot;</span>
mkfs.f2fs -f <span class="token string">&quot;<span class="token variable">${part_root}</span>&quot;</span>

swapon <span class="token string">&quot;<span class="token variable">${part_swap}</span>&quot;</span>
<span class="token function">mount</span> <span class="token string">&quot;<span class="token variable">${part_root}</span>&quot;</span> /mnt
<span class="token function">mkdir</span> /mnt/boot
<span class="token function">mount</span> <span class="token string">&quot;<span class="token variable">${part_boot}</span>&quot;</span> /mnt/boot

<span class="token comment">### Install and configure the basic system ###</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span>/etc/pacman.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[mdaffin]
SigLevel = Optional TrustAll
Server = <span class="token variable">$REPO_URL</span>
EOF</span>

pacstrap /mnt mdaffin-desktop
genfstab -t PARTUUID /mnt <span class="token operator">&gt;&gt;</span> /mnt/etc/fstab
<span class="token keyword">echo</span> <span class="token string">&quot;<span class="token variable">${hostname}</span>&quot;</span> <span class="token operator">&gt;</span> /mnt/etc/hostname

<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span>/mnt/etc/pacman.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[mdaffin]
SigLevel = Optional TrustAll
Server = <span class="token variable">$REPO_URL</span>
EOF</span>

arch-chroot /mnt bootctl <span class="token function">install</span>

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">&gt;</span> /mnt/boot/loader/loader.conf
default arch
EOF

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">&gt;</span> /mnt/boot/loader/entries/arch.conf
title    Arch Linux
linux    /vmlinuz-linux
initrd   /initramfs-linux.img
options  root<span class="token operator">=</span>PARTUUID<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>blkid -s PARTUUID -o value <span class="token string">&quot;<span class="token variable">$part_root</span>&quot;</span><span class="token variable">)</span></span> rw
EOF

<span class="token keyword">echo</span> <span class="token string">&quot;LANG=en_GB.UTF-8&quot;</span> <span class="token operator">&gt;</span> /mnt/etc/locale.conf

arch-chroot /mnt <span class="token function">useradd</span> -mU -s /usr/bin/zsh -G wheel,uucp,video,audio,storage,games,input <span class="token string">&quot;<span class="token variable">$user</span>&quot;</span>
arch-chroot /mnt chsh -s /usr/bin/zsh

<span class="token keyword">echo</span> <span class="token string">&quot;<span class="token variable">$user</span>:<span class="token variable">$password</span>&quot;</span> <span class="token operator">|</span> chpasswd --root /mnt
<span class="token keyword">echo</span> <span class="token string">&quot;root:<span class="token variable">$password</span>&quot;</span> <span class="token operator">|</span> chpasswd --root /mnt
</code></pre></div><h2 id="hosting-and-running-the-installer"><a href="#hosting-and-running-the-installer" aria-hidden="true" class="header-anchor">#</a> Hosting and Running the Installer</h2> <p>Running the script is as simple as downloading it from the Arch Linux live
USB/CD and running the script. To make this easier, since you often cannot copy
in the live environment, you can use a URL shortener such as git.io or goo.gl
to make the URLs easier to type. <em>Remember to use the raw link to the script if
you host it on github or similar sites.</em> Once you have the URL I recommend
adding it to the top of the script or a README in the repo for easy reference
later.</p> <p>Here is the curl line I use in my script.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> -sL https://git.io/vNxbN <span class="token operator">|</span> <span class="token function">bash</span>
</code></pre></div><p>You can also download the script, modify it if required and run it locally.
This can be useful when setting up a system that diverges slightly from your
standard setup or if you want to customise it further.</p> <h2 id="conclusion"><a href="#conclusion" aria-hidden="true" class="header-anchor">#</a> Conclusion</h2> <p>Now you have fully automated the Arch Linux install process, and when combined
with my <a href="/linux/archlinux-repo-in-aws-bucket/">previous</a> <a href="/linux/archlinux-meta-packages/">posts</a> in this series, the whole
configuration side of things as well. I have been using this script in some
form or another for several years now and the best part of it is how easy it is
to hack and change either before you download the script or just before you run
it.</p> <p>You can even take this a step further and bake the installer into a <a href="https://wiki.archlinux.org/index.php/archiso" target="_blank" rel="noopener noreferrer">custom
arch iso<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. But I did not find this worth the effort unless you want to
automate the installation of Arch Linux on multiple identical systems, such as
running Arch with a kiosk browser on a bunch of monitors.</p> <p><em><a href="https://www.reddit.com/r/archlinux/comments/7v7g4w/managing_multiple_arch_linux_systems_with/" target="_blank" rel="noopener noreferrer">Discuss on Reddit<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em></p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Actualizado el: </span> <span class="time">11/12/2018, 7:57:48 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ‚Üê
        <a href="/linux/archlinux-meta-packages/" class="prev">
          Managing Arch Linux with Meta Packages
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/assets/js/16.7972a134.js" defer></script><script src="/assets/js/app.e09b330c.js" defer></script>
  </body>
</html>
